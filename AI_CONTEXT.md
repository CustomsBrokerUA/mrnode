# MRNode — постійний контекст для AI-агента (шпаргалка)

Цей файл потрібен для того, щоб **будь-який AI-агент** після втрати контексту міг швидко зрозуміти:
- як влаштований проєкт
- де лежить ключова логіка
- які правила роботи прийняті в цьому репозиторії
- як правильно робити зміни та деплоїти

## Мова та стиль взаємодії
- Спілкування з власником проєкту: **виключно українською мовою**.
- Відповіді: коротко, по суті, зі структурою.

## Репозиторій і деплой
- Репозиторій: `CustomsBrokerUA/mrnode`
- Продакшн/деплой: **Render тягне код з гілки `main`**.

### Git-процес (обовʼязково для цього проєкту)
- Дозволено прямий push у `main`.
- Бажаний процес на майбутнє: **без ручних кліків у GitHub UI**.
- Стандартний цикл змін:
  1) зробити зміни у коді
  2) перевірити `git status -sb` і `git diff`
  3) **додати тільки потрібні файли** (ніколи не `git add .`, якщо є локальні/службові файли)
  4) `git commit -m "..."`
  5) `git push origin main`
  6) Render авто-деплой (або manual deploy у Render, якщо авто-вимкнений)

### Важливо про локальні файли
У репозиторії можуть зʼявлятися **untracked** файли (наприклад `.txt`, дампи бази і т.д.).
- Їх **не комітити** і **не пушити**.
- Перед комітом завжди перевіряти `git status -sb`.

## Технології (коротко)
- Frontend/Fullstack: **Next.js (App Router)**
- UI: **Tailwind** + **shadcn/ui** компоненти
- DB: **Prisma** (Postgres)
- Авторизація: через `auth()` (див. `src/actions/...`)

## Архів декларацій — ключові вимоги (контекст задач)
Ціль: зробити архів продуктивним і зручним.
- **Справжня серверна пагінація** (не вантажити сотні/тисячі рядків на клієнт)
- Прибрати неактуальні фільтри:
  - `status`
  - `invoiceValueFrom` / `invoiceValueTo`
- Додати **серверні підказки (autocomplete)** з мінімальним навантаженням:
  - митниця (`customsOffice`)
  - відправник (`consignor`)
  - отримувач (`consignee`)
  - контрактотримач (`contractHolder`)
  - УКТЗЕД (`hsCode`)
  - тип декларації (`declarationType`)
- Підказки мають бути:
  - **server-driven**
  - **debounced**
  - з **лімітом** (10–20)

## Де шукати логіку (важливі файли)

### Серверні дії (джерело істини для запитів)
- `src/actions/declarations.ts`
  - `getDeclarationsPaginated(...)` — серверна пагінація + фільтри + сортування
  - `getArchiveStatistics(...)` — серверна статистика (агрегації) для list61
  - `getArchiveAutocompleteSuggestions(...)` — серверні підказки для фільтрів архіву

### Клієнт архіву
- `src/app/dashboard/archive/page-client.tsx`
  - керує станом фільтрів
  - викликає `getDeclarationsPaginated` для списку
  - викликає `getArchiveStatistics` для статистики (list61)
  - передає `companyIds` (для multi-company) у фільтри/підказки

### UI фільтрів
- `src/app/dashboard/archive/components/archive-filters/filters-panel.tsx`
  - UI полів фільтрів
  - робить debounced виклики `getArchiveAutocompleteSuggestions`
  - підставляє підказки в `<datalist>`

## Інваріанти/правила для продуктивності
- Не вантажити важкі поля без потреби (наприклад `xmlData`).
- Для підказок:
  - debounce на клієнті
  - ліміт результатів на сервері
  - враховувати company access (multi-company)

## Як перевіряти після змін (ручний чек-лист)
- Архів list61:
  - фільтри працюють
  - пагінація коректна (total/totalPages)
  - підказки зʼявляються після короткого вводу і не підвішують UI
- HS code підказки:
  - вводиш `84` → отримуєш список кодів
- Перевірити що `status` і `invoiceValueFrom/To` ніде не використовуються (ні UI, ні сервер)

## Типові проблеми та що робити
- `git push origin main` відхиляється (remote contains work):
  - спочатку уточнити у користувача, чи точно треба синхронізуватися з `origin/main`.
  - не робити ризикованих операцій без явної згоди.
- Render не деплоїть:
  - перевірити, що зміни в `main`
  - перевірити налаштування Render: branch=`main`, auto-deploy

---

Якщо ти AI-агент і читаєш цей файл після втрати контексту: почни з `src/actions/declarations.ts` та `src/app/dashboard/archive/page-client.tsx`, і далі рухайся до UI фільтрів у `filters-panel.tsx`.
